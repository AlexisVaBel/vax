<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="vendor/underscore.js" type="text/javascript"></script>
    <script src="vendor/jquery.js" type="text/javascript"></script>
    <script src="vendor/raphael.js" type="text/javascript"></script>
    <script src="vendor/chosen/chosen.jquery.js" type="text/javascript"></script>
    <script src="vax.js" type="text/javascript"></script>
    <script src="schema.js" type="text/javascript"></script>

    <link rel="stylesheet" href="vendor/chosen/chosen.min.css" type="text/css"/>
    <link rel="stylesheet" href="styles.css" type="text/css"/>
</head>
<body>
<style type="text/css">
    body {
        background: #111;
    }
    #eval {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }
</style>
<div id="vax-test" style="width: 1800px; height: 950px;"></div>

<!--
<div class="help">
    <ul>
        <li>Press X to add a new node</li>
        <li>Double click a node caption or a wire to remove it</li>
    </ul>
</div>
-->

<button id="eval" type="button">Eval!</button>


<script type="text/javascript">
    $(function()
    {
        window.myVAX = new VAX('vax-test', {schema: vaxSchema});


        // window.uf = {"version":"0.1","nodes":[{"id":2,"c":"UF_Input","x":517,"y":154,"t":{"T":"BooleanExpr"},"a":{"Name":"1","Title":"Title"}},{"id":6,"c":"UF_Input","x":516,"y":323,"t":{"T":"BooleanExpr"},"a":{"Name":"2","Title":"Title"}},{"id":10,"c":"UF_Input","x":517,"y":505,"t":{"T":"BooleanExpr"},"a":{"Name":"3","Title":"Title"}},{"id":14,"c":"UF_Function","x":1201,"y":518,"a":{"Name":"AND 3","Description":"AND 3"}},{"id":19,"c":"UF_Output","x":1046,"y":416,"t":{"T":"BooleanExpr"},"a":{"Name":"O","Title":"Title"}},{"id":24,"c":"And","x":706,"y":292},{"id":28,"c":"And","x":888,"y":387}],"wires":[[2,"O",24,"A"],[6,"O",24,"B"],[10,"O",28,"B"],[24,"O",28,"A"],[28,"O",19,"I"],[19,"O",14,"Outputs"]]};


        /*var funcId = myVAX.userFunctionStorage.generateNewId();
        var tabId = myVAX.tabs.createNewFunctionTab(funcId, 'TestF', 1);
        myVAX.tabs.switchToTab(tabId);
        myVAX.loadGraph(uf);*/


        var bp = {"version":"0.1","nodes":[{"id":61,"c":"vax_uf_1482676855372_372_10","x":695,"y":304},{"id":64,"c":"GatherColumns","x":945,"y":350},{"id":72,"c":"Tbl_Order","x":470,"y":242,"a":{"Alias":"o"}}],"wires":[[61,"O",64,"A"],[72,"O",61,"I"]]};4
        myVAX.loadGraph(bp);

        // eval
        $('#eval').click(function()
        {
            var trees = myVAX.composeTrees();

            if (trees.length !== 1)
            {
                return alert("There should be exactly one tree!");
            }

            var root = trees[0];

            if (root.c !== "Result")
            {
                return alert("Root node should be 'Result'!");
            }

            var walkCalc = function walk(node)
            {
                if (!node)
                {
                    return '';
                }

                switch (node.c)
                {
                    case 'Result':
                        return 'Result = ' + walk(node.links.I);

                    case 'Add':
                        return walk(node.links.A) + walk(node.links.B);

                    case 'Sub':
                        return walk(node.links.A) - walk(node.links.B);

                    case 'Mul':
                        return walk(node.links.A) * walk(node.links.B);

                    case 'Div':
                        return walk(node.links.A) / walk(node.links.B);

                    case 'Constant':
                        return parseInt(node.a.V);

                    default:
                        throw new Error("Unsupported node component: " + node.component);
                }
            };

            var walkSql = function walkSql(node)
            {
                if (!node)
                {
                    return '';
                }

                switch (node.c)
                {
                    case 'Result':
                        return walkSql(node.links.S);

                    case 'Select':
                        var cols     = walkSql(node.links.Cols);
                        var from     = walkSql(node.links.FROM);
                        var where    = walkSql(node.links.WHERE);
                        var order    = walkSql(node.links.ORDER);
                        var grouping = walkSql(node.links.GROUP);
                        var having   = walkSql(node.links.HAVING);

                        var sql = ' SELECT ' + cols;
                        if (from)
                        {
                            sql = sql + '\n FROM ' + from;
                        }

                        if (where)
                        {
                            sql = sql + '\n WHERE ' + where;
                        }

                        if (order)
                        {
                            sql = sql + '\n ORDER BY ' + order;
                        }

                        if (grouping)
                        {
                            sql = sql + '\n GROUP BY ' + grouping;
                        }

                        if (having)
                        {
                            sql = sql + '\n HAVING ' + having;
                        }

                        return sql;
                        break;

                    case 'Tbl_Order':
                        return 'tbl_order AS ' + node.a.Alias;

                    case 'Tbl_Customer':
                        return 'tbl_customer AS ' + node.a.Alias;

                    case 'Tbl_LegalEntity':
                        return 'tbl_legal_entity AS ' + node.a.Alias;

                    case 'SmartJoin':
                        var l = node.links.L.c;
                        var r = node.links.R.c;

                        var onMap = {
                            'Tbl_Order.Tbl_Customer': 'o.customer_id = ct.id',
                            'Tbl_Customer.Tbl_LegalEntity': 'le.id = ct.legal_entity_id',
                        };

                        return walkSql(node.links.Prev) + '\n ' + node.a.Type + ' JOIN ' + walkSql(node.links.R) + ' ON ' + onMap[l + '.' + r];


                    case 'GroupBy':
                        var exprs = _.filter([walkSql(node.links.E), walkSql(node.links.Prev)]);
                        return exprs.join(', ');

                    case 'GatherColumns':
                        var exprs = _.filter([walkSql(node.links.A), walkSql(node.links.B), walkSql(node.links.C),walkSql(node.links.D), walkSql(node.links.E), walkSql(node.links.Prev)]);
                        return exprs.join(', ');

                    case 'Col_Order_DeliveryStatus':
                        return 'o.delivery_status';

                    case 'LegalEntity_FullName':
                        return " le.inn || le.form_of_institution || ' ' || le.name";

                    case 'TypedEq':
                    case 'Eq':
                        return ' ' + walkSql(node.links.A) + ' = ' + walkSql(node.links.B) + ' ';

                    case 'CustomSql':
                        return node.a.SQL;

                    case 'CountAsteriks':
                        return ' COUNT(*) AS ' + node.a.Alias + ' ';

                    case 'Param':
                        return ' $$' + node.a.title + '$$ ';


                    default:
                        return ''; // throw new Error("Unsupported node component: " + node.component);
                }
            };

            var res = walkSql(root);

            alert(res);
        });
    });
</script>



</body>
</html>