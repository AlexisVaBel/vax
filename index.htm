<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="vendor/underscore.js" type="text/javascript"></script>
    <script src="vendor/jquery.js" type="text/javascript"></script>
    <script src="vendor/raphael.js" type="text/javascript"></script>
    <script src="vendor/chosen/chosen.jquery.js" type="text/javascript"></script>
    <script src="vax.js" type="text/javascript"></script>
    <script src="schema.js" type="text/javascript"></script>

    <link rel="stylesheet" href="vendor/chosen/chosen.min.css" type="text/css"/>
    <link rel="stylesheet" href="styles.css" type="text/css"/>
</head>
<body>
<style type="text/css">
    body {
        background: #111;
    }
    #eval {
        position: absolute;
        top: 120px;
        left: 1130px;
        z-index: 1000;
    }
    .help {
        position: absolute;
        top: 30px;
        left: 1100px;
        color: white;
        font-family: "Georgia";
        font-variant: small-caps;
        font-weight: bold;
        font-size: 14pt;
    }
</style>
<div id="vax-test" style="width: 1800px; height: 950px;"></div>

<!--
<div class="help">
    <ul>
        <li>Press X to add a new node</li>
        <li>Double click a node caption or a wire to remove it</li>
    </ul>
</div>

<button id="eval" type="button">Eval!</button>
-->


<script type="text/javascript">
    $(function()
    {
        window.myVAX = new VAX('vax-test', {schema: vaxSchema});

        window.bp = {"version":"0.1","nodes":[{"id":"2","c":"Result","x":1260,"y":677},{"id":"4","c":"Select","x":1015,"y":515},{"id":"9","c":"Table","x":67,"y":153,"a":{"T":"tbl_user"}},{"id":"12","c":"GatherColumns","x":800,"y":144},{"id":"19","c":"Column","x":519,"y":95,"a":{"C":"name","A":"name"}},{"id":"24","c":"Column","x":237,"y":321,"a":{"C":"id","A":"id"}},{"id":"29","c":"Or","x":730,"y":616},{"id":"33","c":"Eq","x":497,"y":441},{"id":"47","c":"Eq","x":499,"y":635},{"id":"53","c":"CustomSql","x":115,"y":486,"t":{"T":"NumericExpr"},"a":{"S":"10"}},{"id":"57","c":"CustomSql","x":133,"y":694,"t":{"T":"NumericExpr"},"a":{"S":"12"}}],"wires":[["4","O","2","S"],["9","O","19","R"],["19","O","12","A"],["12","O","4","Columns"],["9","O","24","R"],["24","O","12","B"],["24","O","33","A"],["33","O","29","A"],["29","O","4","Where"],["9","O","4","From"],["47","O","29","B"],["24","O","47","A"],["53","O","33","B"],["57","O","47","B"]]};



        // eval
        $('#eval').click(function()
        {
            var trees = myVAX.composeTrees();

            if (trees.length !== 1)
            {
                return alert("There should be exactly one tree!");
            }

            var root = trees[0];

            if (root.component !== "Result")
            {
                return alert("Root node should be 'Result'!");
            }

            var walk = function walk(node)
            {
                if (!node)
                {
                    return 0;
                }

                switch (node.component)
                {
                    case 'Result':
                        return 'Result = ' + walk(node.links.I);

                    case 'Add':
                        return walk(node.links.A) + walk(node.links.B);

                    case 'Sub':
                        return walk(node.links.A) - walk(node.links.B);

                    case 'Mul':
                        return walk(node.links.A) * walk(node.links.B);

                    case 'Div':
                        return walk(node.links.A) / walk(node.links.B);

                    case 'Constant':
                        return parseInt(node.attrs.V);

                    default:
                        throw new Error("Unsupported node component: " + node.component);
                }
            };

            var res = walk(root);

            alert(res);
        });
    });
</script>



</body>
</html>