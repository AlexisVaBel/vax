<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="vendor/underscore.js" type="text/javascript"></script>
    <script src="vendor/jquery.js" type="text/javascript"></script>
    <script src="vendor/raphael.js" type="text/javascript"></script>
    <script src="vendor/raphael-paragraph.js" type="text/javascript"></script>
    <script src="vendor/chosen/chosen.jquery.js" type="text/javascript"></script>
    <script src="vax.js" type="text/javascript"></script>
    <script src="schema.js" type="text/javascript"></script>

    <link rel="stylesheet" href="vendor/chosen/chosen.min.css" type="text/css"/>
    <link rel="stylesheet" href="styles.css" type="text/css"/>
</head>
<body>
<style type="text/css">
    body {
        background: #111;
    }
    #eval {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }
    #save {
        position: absolute;
        top: 40px;
        right: 10px;
        z-index: 1000;
    }
    #load {
        position: absolute;
        top: 70px;
        right: 10px;
        z-index: 1000;
    }
</style>
<div id="vax-test" style="width: 1800px; height: 950px;"></div>

<!--
<div class="help">
    <ul>
        <li>Press X to add a new node</li>
        <li>Double click a node caption or a wire to remove it</li>
    </ul>
</div>
-->

<button id="eval" type="button">Eval!</button>
<button id="save" type="button">Save!</button>
<button id="load" type="button">Load!</button>


<script type="text/javascript">
    $(function()
    {
        window.myVAX = new VAX('vax-test', {schema: vaxSchema});



        var bp = JSON.parse(window.localStorage.getItem('sessionGraph'));
        myVAX.loadGraph(bp);


        /*var txt = "Very long text wtf is this shit I gotta work now \n Holy moy schlo asf f asf ";
        var p = myVAX.raphael.paragraph({x: 100, y: 100, maxWidth: 100, lineHeight: 20, maxHeight: 50, text: txt});
        p.attr({title: txt});

        window.console.debug(p);*/

        $('#save').click(function()
        {
            window.localStorage.setItem('sessionGraph', myVAX.serializeGraph());
        });

        $('#load').click(function()
        {
            var graph = window.localStorage.getItem('sessionGraph');
            myVAX.loadGraph(JSON.parse(graph));
        });

        // eval
        $('#eval').click(function()
        {
            var trees = myVAX.composeTrees();

            if (trees.length !== 1)
            {
                return alert("There should be exactly one tree!");
            }

            var root = trees[0];

            if (root.c !== "Result")
            {
                return alert("Root node should be 'Result'!");
            }

            var walkCalc = function walk(node)
            {
                if (!node)
                {
                    return '';
                }

                switch (node.c)
                {
                    case 'Result':
                        return 'Result = ' + walk(node.links.I);

                    case 'Add':
                        return walk(node.links.A) + walk(node.links.B);

                    case 'Sub':
                        return walk(node.links.A) - walk(node.links.B);

                    case 'Mul':
                        return walk(node.links.A) * walk(node.links.B);

                    case 'Div':
                        return walk(node.links.A) / walk(node.links.B);

                    case 'Constant':
                        return parseInt(node.a.V);

                    default:
                        throw new Error("Unsupported node component: " + node.component);
                }
            };

            var walkSql = function walkSql(node)
            {
                if (!node)
                {
                    return '';
                }

                switch (node.c)
                {
                    case 'Result':
                        return walkSql(node.links.S);

                    case 'Select':
                        var cols     = walkSql(node.links.Cols);
                        var from     = walkSql(node.links.FROM);
                        var where    = walkSql(node.links.WHERE);
                        var order    = walkSql(node.links.ORDER);
                        var grouping = walkSql(node.links.GROUP);
                        var having   = walkSql(node.links.HAVING);

                        var sql = ' SELECT ' + cols;
                        if (from)
                        {
                            sql = sql + '\n FROM ' + from;
                        }

                        if (where)
                        {
                            sql = sql + '\n WHERE ' + where;
                        }

                        if (order)
                        {
                            sql = sql + '\n ORDER BY ' + order;
                        }

                        if (grouping)
                        {
                            sql = sql + '\n GROUP BY ' + grouping;
                        }

                        if (having)
                        {
                            sql = sql + '\n HAVING ' + having;
                        }

                        return sql;
                        break;

                    case 'Tbl_Order':
                        return 'tbl_order AS ' + node.a.Alias;

                    case 'Tbl_Customer':
                        return 'tbl_customer AS ' + node.a.Alias;

                    case 'Tbl_LegalEntity':
                        return 'tbl_legal_entity AS ' + node.a.Alias;

                    case 'SmartJoin':
                        var l = node.links.L.c;
                        var r = node.links.R.c;

                        var onMap = {
                            'Tbl_Order.Tbl_Customer': 'o.customer_id = ct.id',
                            'Tbl_Customer.Tbl_LegalEntity': 'le.id = ct.legal_entity_id',
                        };

                        return walkSql(node.links.Prev) + '\n ' + node.a.Type + ' JOIN ' + walkSql(node.links.R) + ' ON ' + onMap[l + '.' + r];


                    case 'GroupBy':
                        var exprs = _.filter([walkSql(node.links.E), walkSql(node.links.Prev)]);
                        return exprs.join(', ');

                    case 'GatherColumns':
                        var exprs = _.filter([walkSql(node.links.A), walkSql(node.links.B), walkSql(node.links.C),walkSql(node.links.D), walkSql(node.links.E), walkSql(node.links.Prev)]);
                        return exprs.join(', ');

                    case 'Col_Order_DeliveryStatus':
                        return 'o.delivery_status';

                    case 'LegalEntity_FullName':
                        return " le.inn || le.form_of_institution || ' ' || le.name";

                    case 'TypedEq':
                    case 'Eq':
                        return ' ' + walkSql(node.links.A) + ' = ' + walkSql(node.links.B) + ' ';

                    case 'CustomSql':
                        return node.a.SQL;

                    case 'CountAsteriks':
                        return ' COUNT(*) AS ' + node.a.Alias + ' ';

                    case 'Param':
                        return ' $$' + node.a.title + '$$ ';


                    default:
                        return ''; // throw new Error("Unsupported node component: " + node.component);
                }
            };

            var res = walkSql(root);

            alert(res);
        });
    });
</script>



</body>
</html>